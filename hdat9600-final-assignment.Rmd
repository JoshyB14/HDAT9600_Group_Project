---
title: "HDAT9600 Final Assignment"
subtitle: "Submission deadline is 23:59 Monday 24 August 2020 AEST"
author: "insert your team name here"
date: "insert date of completion here"
output: html_document
---

```{r setup, include=FALSE}
# leave this code here, but feel free to adjust the options or add some more
# see the knitr documentation for details
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=12)
```

## Instructions

This file (hdat9600_final_assignment.Rmd) is the R Markdown document in which you need to complete your HDAT9600 final assignment. This assignment is assessed and will count for 30% of the total course marks. The assignment comprises two tasks worth 15 marks each. The first task will focus on logistic regression, and the second task will focus on survival analysis. There is no word limit, but a report of about 10 pages in length when printed (except that it will not be printed) is appropriate.

Don't hesitate to ask the course convenor for help via OpenLearning. The course instructor are happy to point you in the right direction and to make suggestions, but they won't, of course, complete your assignments for you!


## Data for this assignment

The data used for this assignment consist of records from Intensive Care Unit (ICU) hospital stays in the USA. All patients were adults who were admitted for a wide variety of reasons. ICU stays of less than 48 hours have been excluded. 

The source data for the assignment are data made freely available for the 2012 MIT PhysioNet/Computing for Cardiology Challenge. Details are provided [here](https://physionet.org/challenge/2012/). Training Set A data have been used. The original data has been modified and assembled to suit the purpose of this assignment. While not required for the purposes of this assignment, full details of the preparatory work can be found in the hdat9600-final-assignment-data-preparation file.

The dataframe consists of 120 variables, which are defined as follows:

#### Patient Descriptor Variables
<li> <em>RecordID:</em>   a unique integer for each ICU stay</li>
<li> <em>Age:</em>                 years</li>
<li> <em>Gender:</em>              male/female</li>
<li> <em>Height:</em>              cm</li>
<li> <em>ICUType:</em>             Coronary Care Unit; Cardiac Surgery Recovery Unit; Medical ICU; Surgical ICU</li>
<li> <em>Length_of_stay:</em>      The number of days between the patientâ€™s admission to the ICU and the end of hospitalisation</li>
<li> <em>Survival:</em>            The number of days between ICU admission and death for patients who died</li>


#### Outcome Variables
<li> <em>in_hospital_death:</em>   0:survivor/1:died in-hospital **this is the outcome variable for Task 1: Logistic Regression**</li>
<li> <em>Status:</em>              True/False **this is the censoring variable for Task 2: Survival Analysis**</li>
<li> <em>Days:</em>                Length of survival (in days) **this is the survival time variable for Task 2: Survival Analysis**</li>


#### Clinical Variables
<em>Use the hyperlinks below to find out more about the clinical meaning of each variable.</em>
The first two clinical variables are summary scores that are used to assess patient condition and risk.

<li> <em>SAPS-I score</em> [Simplified Acute Physiological Score (<a href="http://www.ncbi.nlm.nih.gov/pubmed/6499483"
target="_blank"><em>Le Gall et al., 1984</em></a>)]</li>
<li> <em>SOFA score</em> [Sequential Organ Failure Assessment (<a href="http://www.ncbi.nlm.nih.gov/pubmed/11594901"
target="_blank"><em>Ferreira et al., 2001</em></a>)]</li>

###

The following 36 clinical measures were assessed at multiple timepoints during each patient's ICU stay. For each of the 36 clinical measures, you are given 3 summary variables: a) The minimum value during the first 24 hours in ICU (_min), b) The maximum value during the first 24 hours in ICU (_max), and c) The difference between the mean and the most extreme values during the first 24 hours in ICU (_diff). For example, for the clinical measure Cholesterol, these three variables are labelled 'Cholesterol_min', 'Cholesterol_max', and 'Cholesterol_diff'.

<li><a href="http://en.wikipedia.org/wiki/Human_serum_albumin" target="_blank">
<em>Albumin</em></a> (g/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Alkaline_phosphatase" target="_blank">
<em>ALP</em></a> [Alkaline phosphatase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Alanine_transaminase" target="_blank">
<em>ALT</em></a> [Alanine transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Aspartate_transaminase" target="_blank">
<em>AST</em></a> [Aspartate transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bilirubin" target="_blank">
<em>Bilirubin</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/BUN" target="_blank">
<em>BUN</em></a> [Blood urea nitrogen (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Cholesterol" target="_blank">
<em>Cholesterol</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_creatinine#Plasma_creatinine"
target="_blank">
<em>Creatinine</em></a> [Serum creatinine (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>DiasABP</em></a> [Invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/FIO2" target="_blank">
<em>FiO2</em></a> [Fractional inspired O<sub>2</sub> (0-1)]</li>
<li><a href="http://en.wikipedia.org/wiki/Glasgow_coma_score" target="_blank">
<em>GCS</em></a> [Glasgow Coma Score (3-15)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_glucose" target="_blank">
<em>Glucose</em></a> [Serum glucose (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bicarbonate#Diagnostics"
target="_blank">
<em>HCO3</em></a> [Serum bicarbonate (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hematocrit" target="_blank">
<em>HCT</em></a> [Hematocrit (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Heart_rate" target="_blank">
<em>HR</em></a> [Heart rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hypokalemia" target="_blank">
<em>K</em></a> [Serum potassium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Lactic_acid" target="_blank">
<em>Lactate</em></a> (mmol/L)</li>
<li><a href="http://en.wikipedia.org/wiki/Magnesium#Biological_role"
target="_blank">
<em>Mg</em></a> [Serum magnesium (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>MAP</em></a> [Invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mechanical_ventilation"
target="_blank">
<em>MechVent</em></a> [Mechanical ventilation respiration (0:false, or 1:true)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_sodium" target="_blank">
<em>Na</em></a> [Serum sodium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>NIDiasABP</em></a> [Non-invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>NIMAP</em></a> [Non-invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>NISysABP</em></a> [Non-invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaCO2</em></a> [partial pressure of arterial CO<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaO2</em></a> [Partial pressure of arterial O<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>pH</em></a> [Arterial pH (0-14)]</li>
<li><a href="http://en.wikipedia.org/wiki/Platelets" target="_blank">
<em>Platelets</em></a> (cells/nL)</li>
<li><a href="http://en.wikipedia.org/wiki/Respiratory_physiology" target="_blank">
<em>RespRate</em></a> [Respiration rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>SaO2</em></a> [O<sub>2</sub> saturation in hemoglobin (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>SysABP</em></a> [Invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Normal_human_body_temperature"
target="_blank">
<em>Temp</em></a> [Temperature (&deg;C)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropI</em></a> [Troponin-I (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropT</em></a> [Troponin-T (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Fluid_balance" target="_blank">
<em>Urine</em></a> [Urine output (mL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Reference_ranges_for_blood_tests#Hematology" target="_blank">
<em>WBC</em></a> [White blood cell count (cells/nL)]</li>
<li>
<em>Weight</em> (kg)</li>


## Accessing the Data
The data frame can be loaded with the following code:

```
icu_patients_df0 <- readRDS("icu_patients_df0.rds")
icu_patients_df1 <- readRDS("icu_patients_df1.rds")
```
**Note:** icu_patients_df1 is an imputed (i.e. missing values are 'derived') version of icu_patients_df0.  This assignment does not concern the methods used for imputation.


# Task 1 (15 marks)

In this task, you are required to develop a logistic regression model using the `icu_patients_df1` data set which adequately explains or predicts the `in_hospital_death` variable as the outcome using a subset of the available predictor variables. You should fit a series of models, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct or complete, but do you best). Aim for between five and ten predictor variables (slightly more or fewer is OK). You should assess each model you consider for goodness of fit and other relevant statistics to help you choose between them. For your final model, present a set of diagnostic statistics and/or charts and comment on them. You don't need to do an exhaustive exploratory data analysis of all the variables in the data set, but you should examine those variables that you use in your model. Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find compared to the same model fitted to the imputed data. 


### Hints

1. Select an initial subset of explanatory variables that you will use to predict the risk of in-hospital death. Justify your choice.

2. Conduct basic exploratory data analysis on your variables of choice.

3. Fit appropriate univariate logistic regression models.

4. Fit an appropriate series of multivariable logistic regression models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them.

7. Write a paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation.



#####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 

   Regarding which variables to include in the model selection process we decided to first include the basic patient descriptor variables age and gender, as it is a good idea to inspect these regardless of the sort of their suspected significance. Furthermore, the type of ICU and length of stay were also included, as were both the SAPS-I score and the SOFA score. We hypothesized the ICU type may be an indicator of the severity of the patient's condition, and thus a reasonable predictor of mortality. The SOFA AND SAPS-I scores are risk assessment measures, ergo they are an obvious choice to include for further inspection. 

   We also included the minimum white blood cell count. A low white blood cell count is indicative of a weak immune system, a person with no white blood cells is incapable of fighting infection, and thus is more likely to die from a variety of conditions than someone with a sufficient amount of white blood cells. The maximum creatine level was included as this is a common measure of renal function. Fi02 was chosen as a candidate variable over Pa02 because you can titrate Fi02 to correct low Pa02 until later stages of disease. Maximum lactate was examined as it is often elevated in states of hypoperfusion. Extremes at the high and low ends of the pH scale often warrant a poor prognosis, thus both considered. Tropinon, a cardiac enzyme, is elevated in myocardial ischaemia. Finally, temperature and glucose levels, both at a maximum and minimum, were explored. 

# Exploratory Data Analysis
```{r}
# Libraries
library(dplyr)
library(ggplot2)
library(DescTools)
library(faraway)
library(arm)
library(ROCR)
```

```{r}
# Reading in the data sets
icu_patients_df0 <- readRDS("icu_patients_df0.rds")
icu_patients_df1 <- readRDS("icu_patients_df1.rds")
```



   From the EDA below for patient descriptor variables it can be observed that the oldest patient in the data set was 90, the youngest 16, with the median age being 67. On average, the women admitted to the ICU were slightly older than the men, 65.5 years old compared to 63.5. However, by frequency there were more male patients (1148) than female patients (913). 

```{r}
# EDA for the patient descriptor variables

# -------------------- General summary statistics by variable ----------------#
summary(icu_patients_df1$Age)
table(icu_patients_df1$Gender)

# ----------------------  Age by gender ------------------------------------- #
# Plot
ggplot(data = icu_patients_df1, aes(x = Age, fill = Gender)) + geom_histogram() +
   facet_grid(Gender ~ .) + ggtitle("Distribution of age by gender")

# Summary Statistics
group_by(icu_patients_df1, Gender) %>% summarize(mean_age = mean(Age))

```
   The clinical variables are SOFA and SAPS-I scores. SOFA stands for sequential organ failure assessment. It is a mortality prediction score based on the degree of dysfunction of six organ systems. The SAPS-I score is another mortality risk prediction measure that is calculated from 14 routine physiological measurements. Note that in the histograms below the vertical red line indicates the mean of the plotted measurement. 


```{r}
# EDA for clinical variables

# SOFA summary and plot
summary(icu_patients_df1$SOFA)
ggplot(data = icu_patients_df1, aes(x = SOFA)) + geom_histogram(fill = "cornflowerblue") + 
   geom_vline(xintercept = mean(icu_patients_df1$SOFA), col = "red") +
   ggtitle("Distribution of SOFA scores")
  
# SAPS1 summary and plot
summary(icu_patients_df1$SAPS1)
ggplot(data = icu_patients_df1, aes(x = SAPS1)) + geom_histogram(fill = "cornflowerblue") +
   geom_vline(xintercept = mean(na.exclude(icu_patients_df1$SAPS1)), col = "red") +
   ggtitle("Distribution of SAPS1 scores")
```
   Brief EDA for the remaining clinical variables is presented below. Similarly to the above plots, the vertical line represents the mean for that particular measure. The distributions vary in shape, but structurally everything appears to be in order with the data entry of the measurements. 

```{r}
# EDA for other variables

# ICU type
table(icu_patients_df1$ICUType)

# White blood cell (minimum) count
summary(icu_patients_df1$WBC_min)
ggplot(data = icu_patients_df1, aes(x = WBC_min)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$WBC_min), col = "cornflowerblue") +
   ggtitle("Distribution of minimum white blooc cell counts")

# WBC diff count
summary(icu_patients_df1$WBC_diff)
ggplot(data = icu_patients_df1, aes(x = WBC_diff)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$WBC_diff), col = "cornflowerblue") +
   ggtitle("Distribution of white blood cell count differences between mean and most extreme value")

# Creatine (max)
summary(icu_patients_df1$Creatinine_max)
ggplot(data = icu_patients_df1, aes(x = Creatinine_max)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$Creatinine_max), col = "cornflowerblue") +
   ggtitle("Distribution of maximum creatinine measurements")

# albumin (min)
summary(icu_patients_df1$Albumin_min)
ggplot(data = icu_patients_df1, aes(x = Albumin_min)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$Albumin_min), col = "cornflowerblue") +
   ggtitle("Distribution of minimum albumin measurements")

# Fi02
summary(icu_patients_df1$FiO2_max)
ggplot(data = icu_patients_df1, aes(x = FiO2_max)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$FiO2_max), col = "cornflowerblue") +
   ggtitle("Distribution of maximum FiO2 measurements")

# lactate (max)
summary(icu_patients_df1$Lactate_max)
ggplot(data = icu_patients_df1, aes(x = Lactate_max)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$Lactate_max), col = "cornflowerblue") +
   ggtitle("Distribution of maximum lactate measurements")

# pH (max and min)
summary(icu_patients_df1$pH_max)
ggplot(data = icu_patients_df1, aes(x = pH_max)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$pH_max), col = "cornflowerblue") +
   ggtitle("Distribution of maximum pH measurements")

summary(icu_patients_df1$pH_min)
ggplot(data = icu_patients_df1, aes(x = pH_min)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$pH_min), col = "cornflowerblue") +
   ggtitle("Distribution of minimum pH measurements")

# Temperature(max and min)
summary(icu_patients_df1$Temp_max)
ggplot(data = icu_patients_df1, aes(x = Temp_max)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$Temp_max), col = "cornflowerblue") +
   ggtitle("Distribution of maximum temperature measurements")

summary(icu_patients_df1$Temp_min)
ggplot(data = icu_patients_df1, aes(x = Temp_min)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$Temp_min), col = "cornflowerblue") +
   ggtitle("Distribution of minimum temperature measurements")

# MAP (min and max)
summary(icu_patients_df1$MAP_max)
ggplot(data = icu_patients_df1, aes(x = MAP_max)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$MAP_max), col = "cornflowerblue") +
   ggtitle("Distribution of maximum MAP measurements")

summary(icu_patients_df1$MAP_min)
ggplot(data = icu_patients_df1, aes(x = MAP_min)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$MAP_min), col = "cornflowerblue") +
   ggtitle("Distribution of minimum MAP measurements")

# Glusoce (max and min)
summary(icu_patients_df1$Glucose_max)
ggplot(data = icu_patients_df1, aes(x = Glucose_max)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$Glucose_max), col = "cornflowerblue") +
   ggtitle("Distribution of maximum glusoce measurements")

summary(icu_patients_df1$Glucose_min)
ggplot(data = icu_patients_df1, aes(x = Glucose_min)) + geom_histogram(fill = "salmon1") +
   geom_vline(xintercept = mean(icu_patients_df1$Glucose_min), col = "cornflowerblue") +
   ggtitle("Distribution of minimum glusoce measurements")

```

## Model Fitting

   Next, we fit each candidate variable as a univariate predictor of in hospital mortality. Out of the patient descriptor variables age was found to be significant while gender was not. Both clinical risk predictions scores were found to be significant, as was ICU type. Among the additional clinical measures we chose as candidate variables only FiO2 (max), pH (max), temperature (max), MAP (max and min), and glucose (min) were found to not be significant. 


```{r}
# Fitting univariate models for the predictors chosen so far

# Univariate fits
age_fit        <- glm(in_hospital_death ~ Age, family  = "binomial", data = icu_patients_df1)
gender_fit     <- glm(in_hospital_death ~ Gender, family = "binomial", data = icu_patients_df1)
SAPS_fit       <- glm(in_hospital_death ~ SAPS1, family = "binomial", data = icu_patients_df1)
SOFA_fit       <- glm(in_hospital_death ~ SOFA, family = "binomial", data = icu_patients_df1)
WBCmin_fit     <- glm(in_hospital_death ~ WBC_min, family = "binomial", data = icu_patients_df1)
WBCdiff_fit    <- glm(in_hospital_death ~ WBC_diff, family = "binomial", data = icu_patients_df1)
creatine_fit   <- glm(in_hospital_death ~ Creatinine_max, family = "binomial", data = icu_patients_df1)
albumin_fit    <- glm(in_hospital_death ~ Albumin_min, family = "binomial", data = icu_patients_df1)
fio2_fit       <- glm(in_hospital_death ~ FiO2_max, family = "binomial", data = icu_patients_df1)
lactate_fit    <- glm(in_hospital_death ~ Lactate_max, family = "binomial", data = icu_patients_df1)
pHmax_fit      <- glm(in_hospital_death ~ pH_max, family = "binomial", data = icu_patients_df1)
pHmin_fit      <- glm(in_hospital_death ~ pH_min, family = "binomial", data = icu_patients_df1)
tempmax_fit    <- glm(in_hospital_death ~ Temp_max, family = "binomial", data = icu_patients_df1)
tempmin_fit    <- glm(in_hospital_death ~ Temp_min, family = "binomial", data = icu_patients_df1)
mapmax_fit     <- glm(in_hospital_death ~ MAP_max, family = "binomial", data = icu_patients_df1)
mapmin_fit     <- glm(in_hospital_death ~ MAP_min, family = "binomial", data = icu_patients_df1)
glucosemax_fit <- glm(in_hospital_death ~ Glucose_max, family = "binomial", data = icu_patients_df1)
glucosemin_fit <- glm(in_hospital_death ~ Glucose_min, family = "binomial", data = icu_patients_df1)
ICUtype_fit    <- glm(in_hospital_death ~ ICUType, family = "binomial", data = icu_patients_df1)

# Summaries
summary(age_fit)        # significant, AIC = 1648.9
summary(gender_fit)     # non significant
summary(SAPS_fit)       # significant, AIC = 1534.8
summary(SOFA_fit)       # significant, AIC = 1611.5
summary(WBCmin_fit)     # significant, AIC = 1699.6
summary(WBCdiff_fit)    # significant, AIC = 1694.7 ,ONLY CHOOSE WBC_MIN OR WBC_DIFF TO AVOID MULTICOLLINEARITY
summary(creatine_fit)   # significant, AIC = 1678.4
summary(albumin_fit)    # significant, AIC = 1680
summary(fio2_fit)       # not significant
summary(lactate_fit)    # significant, AIC = 1673.5
summary(pHmax_fit)      # not significant
summary(pHmin_fit)      # significant, AIC = 1681.4
summary(tempmax_fit)    # not significant
summary(tempmin_fit)    # significant, AIC = 1688.3
summary(mapmax_fit)     # not significant, AIC = 1703.7
summary(mapmin_fit)     # not significant
summary(glucosemax_fit) # significant, AIC = 1688.2
summary(glucosemin_fit) # not significant 
summary(ICUtype_fit) # significant, AIC = 1663.3
```

   From the univariate fits we chose to further examine a number of models. The first of which contained all predictors significant in the univariate analyses, as well as gender. From there, given that all candidate variables have been deemed either statistically and/or clinically significant, we employed backwards elimination to minimize AIC and find the optimal model. Judging by AIC, BIC, and other metric provided by the *PseudoR2* function it can be observed that the model fit using backwards elimination is preferable. Thus, our final model included the predictors: age, SAPS1, SOFA, maximum lactate measurement, as well as ICU type. While this model may seem rather simple, it should be noted that the SOFA and SAPS1 scores are derived from many of the clinical measurements in the data set and thus their importance is captured in the background. 

```{r}
# Skeleton code for picking the next few models

# Candidate models from above variables
cand_1_fit <- glm(in_hospital_death ~ Age + Gender + SAPS1 + SOFA + WBC_diff + Creatinine_max + Albumin_min + Lactate_max + 
                     pH_min + Temp_min + Glucose_max + ICUType, family = "binomial", data = icu_patients_df1)

cand_backelim_fit <- step(cand_1_fit, direction = "back")

# Summaries
summary(cand_1_fit)
summary(cand_backelim_fit)

# Comparing the two
PseudoR2(cand_1_fit, which = "all")
PseudoR2(cand_backelim_fit, which = "all")

```

## Model Diagnostics

When diagnosing the quality of the model we first examined the binned residuals plot. Initially, slight alarm was raised over the residuals on the leftmost side of the bottom half of the plot. However, the residuals seem to broadly be acceptable. The halfnorm plot indicated two values of concern. Upon further investigation these patients had normal measurements for the variables used in our final model. Given the large size of the data these two patients should not be of much concern. 

```{r}
# Renaming final model
final_model <- cand_backelim_fit

# Residual checks
binnedplot(predict(final_model), residuals(final_model))

# Outlier checks
halfnorm(hatvalues(final_model))
# Inspecting suspect values
icu_patients_df1[hatvalues(final_model) > 0.04, c("in_hospital_death", "Age", "ICUType", "SOFA", "SAPS1")]

# ROC curve
#pred_prob = predict(final_model, type = "response")
#label_vec <- na.exclude(icu_patients_df1$in_hospital_death)
#pred <- prediction(pred_prob, label_vec, label.ordering = NULL)
#perf <- performance(pred, measure = "tpr", x.measure = "fpr")
#plot(perf, col = rainbow(10))

```
When interpreting the model it is best to default to the odds, thus, we first exponentiated the repression coefficients. The interpretation of such odds are as follows: the odds of dying in the ICU are 2.9% greater for every 1 year increase in age, 7.4% greater for every unit increase in SAPS1 score, 10.3% higher for every unit increase in SOFA score, 5.6% greater for every unit increase in maximum lactate measurement, 80.5% lower if you are in the surgical recovery unit compared to baseline (coronary care unit), 22.2% higher if you are in the medical ICU compared to baseline, and about 10% lower if you are in the surgical ICU compared to baseline.   

```{r}
final_coef <- coef(final_model)
exp(final_coef)
```

After fitting the model the the unimputed data set we can see that the AIC is actually much lower, and more variables are significant at the 0.05 level. 

```{r}
# Fitting final model to second ICU data set
final_model_newdata <- glm(in_hospital_death ~ Age + SAPS1 + SOFA + Lactate_max + ICUType, data = icu_patients_df0)
summary(final_model_newdata)

```



# Task 2 (15 marks)

In this task, you are required to develop a Cox proportional hazards survival model using the `icu_patients_df1` data set which adequately explains or predicts the length of survival indicated by the `Days` variable, with censoring as indicated by the `Status` variable.  You should fit a series of models, maybe three or four, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. Aim for between five and ten predictor variables (slightly more or fewer is OK). It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct, but do you best). You should assess each model you consider for goodness of fit and other relevant statistics, and you should assess your final model for violations of assumptions and perform other diagnostics which you think are relevant (and modify the model if indicated, or at least comment on the possible impact of what your diagnostics show). Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find.


### Hints

1. Select an initial subset of explanatory variables that you will use to predict survival. Justify your choice.

2. Conduct basic exploratory data analysis on your variables of choice.

3. Fit appropriate univariate Cox proportional hazards models.

4. Fit an appropriate series of multivariable Cox proportional hazards models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them. 

7. Write a very brief paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation. 

####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 
```{r}
# basic EDA in task2

# load the survival library
library(survival)
# read the dataset
head(icu_patients_df1)
nrow(icu_patients_df1)
# Note: status = TRUE = event occurred, status = FALSE = no event 

# summary the number of days
summary(icu_patients_df1$Days)
hist(icu_patients_df1$Days)

# check the status
table(icu_patients_df1$Status)

# check age and gender
summary(icu_patients_df1$Age)
table(icu_patients_df1$Gender)

# hist survival
survival_year <- icu_patients_df1$Survival / 365
hist(survival_year)

# fit the KM (survival) model for data
km.model <- survfit( Surv(Days, Status) ~ 1, type="kaplan-meier", data=icu_patients_df1)
plot(km.model, xlim = c(1,2500), main="kaplan-meier survical curve", xlab = "Time(days)",
     ylab = " % Alive = S(t)")
abline(h=0.5,col="red")

# fit the KM (survival) model by gender
km.model_gender <- survfit( Surv(Days, Status) ~ Gender, type="kaplan-meier", data=icu_patients_df1)
plot(km.model_gender, main="kaplan-meier survical curve", xlab = "Time(days)",ylab = " % Alive = S(t)", col=c("red","blue"))


```

```{r}
# just some intial EDA on some target variables as mentioned on the Task 2 issue forum on Github...

# ----------------------------------------Gender----------------------------#
summary(icu_patients_df1$Gender)

# ----------------------------------------WBC_diff----------------------------#
summary(icu_patients_df1$WBC_diff)
ggplot(data = icu_patients_df1, aes(x = WBC_diff)) + geom_histogram(fill = "red")+
ggtitle("WBC_diff histogram")

# ----------------------------------------WBC_min----------------------------#
summary(icu_patients_df1$WBC_min)
ggplot(data = icu_patients_df1, aes(x = WBC_min)) + geom_histogram(fill = "red")+
ggtitle("WBC_min histogram")

# ----------------------------------------WBC_max----------------------------#
summary(icu_patients_df1$WBC_max)
ggplot(data = icu_patients_df1, aes(x = WBC_max)) + geom_histogram(fill = "red")+
ggtitle("WBC_max histogram")

# ----------------------------------------SaO2_diff----------------------------#
summary(icu_patients_df1$SaO2_diff)
ggplot(data = icu_patients_df1, aes(x = SaO2_diff)) + geom_histogram(fill = "red")+
ggtitle("SaO2_diff histogram")

# ----------------------------------------SaO2_min----------------------------#
summary(icu_patients_df1$SaO2_min)
ggplot(data = icu_patients_df1, aes(x = SaO2_min)) + geom_histogram(fill = "red")+
ggtitle("SaO2_min histogram")

# ----------------------------------------SaO2_max----------------------------#
summary(icu_patients_df1$SaO2_max)
ggplot(data = icu_patients_df1, aes(x = SaO2_max)) + geom_histogram(fill = "red")+
ggtitle("SaO2_max histogram")

# ----------------------------------------MAP_diff----------------------------#
summary(icu_patients_df1$MAP_diff)
ggplot(data = icu_patients_df1, aes(x = MAP_diff)) + geom_histogram(fill = "red")+
ggtitle("MAP_diff histogram")

# ----------------------------------------MAP_min----------------------------#
summary(icu_patients_df1$MAP_min)
ggplot(data = icu_patients_df1, aes(x = MAP_min)) + geom_histogram(fill = "red")+
ggtitle("MAP_min histogram")

# ----------------------------------------MAP_max----------------------------#
summary(icu_patients_df1$MAP_max)
ggplot(data = icu_patients_df1, aes(x = MAP_max)) + geom_histogram(fill = "red")+
ggtitle("MAP_max histogram")

# ----------------------------------------Glucose_diff----------------------------#
summary(icu_patients_df1$Glucose_diff)
ggplot(data = icu_patients_df1, aes(x = Glucose_diff)) + geom_histogram(fill = "red")+
ggtitle("Glucose_diff histogram")

# ----------------------------------------Glucose_min----------------------------#
summary(icu_patients_df1$Glucose_min)
ggplot(data = icu_patients_df1, aes(x = Glucose_min)) + geom_histogram(fill = "red")+
ggtitle("Glucose_min histogram")

# ----------------------------------------Glucose_max----------------------------#
summary(icu_patients_df1$Glucose_max)
ggplot(data = icu_patients_df1, aes(x = Glucose_max)) + geom_histogram(fill = "red")+
ggtitle("Glucose_max histogram")

# ----------------------------------------Albumin_diff----------------------------#
summary(icu_patients_df1$Albumin_diff)
ggplot(data = icu_patients_df1, aes(x = Albumin_diff)) + geom_histogram(fill = "red")+
ggtitle("Albumin_diff histogram")

# ----------------------------------------Albumin_min----------------------------#
summary(icu_patients_df1$Albumin_min)
ggplot(data = icu_patients_df1, aes(x = Albumin_min)) + geom_histogram(fill = "red")+
ggtitle("Albumin_min histogram")

# ----------------------------------------Albumin_max----------------------------#
summary(icu_patients_df1$Albumin_max)
ggplot(data = icu_patients_df1, aes(x = Albumin_max)) + geom_histogram(fill = "red")+
ggtitle("Albumin_max histogram")

# ----------------------------------------Cholesterol_diff----------------------------#
summary(icu_patients_df1$Cholesterol_diff)
ggplot(data = icu_patients_df1, aes(x = Cholesterol_diff)) + geom_histogram(fill = "red")+
ggtitle("Cholesterol_diff histogram")

# ----------------------------------------Cholesterol_min----------------------------#
summary(icu_patients_df1$Cholesterol_min)
ggplot(data = icu_patients_df1, aes(x = Cholesterol_min)) + geom_histogram(fill = "red")+
ggtitle("Cholesterol_min histogram")

# ----------------------------------------Cholesterol_max----------------------------#
summary(icu_patients_df1$Cholesterol_max)
ggplot(data = icu_patients_df1, aes(x = Cholesterol_max)) + geom_histogram(fill = "red")+
ggtitle("Cholesterol_max histogram")

# ----------------------------------------Creatinine_diff----------------------------#
summary(icu_patients_df1$Creatinine_diff)
ggplot(icu_patients_df1, aes(Creatinine_diff)) + geom_histogram(fill = "red") +
          ggtitle("Creatinine_diff histogram")

# ----------------------------------------Creatinine_max----------------------------#
summary(icu_patients_df1$Creatinine_max)
ggplot(icu_patients_df1, aes(Creatinine_max)) + geom_histogram(fill = "red") +
          ggtitle("Creatinine_max histogram")

# ----------------------------------------Creatinine_min----------------------------#
summary(icu_patients_df1$Creatinine_min)
ggplot(icu_patients_df1, aes(Creatinine_min)) + geom_histogram(fill = "red") +
          ggtitle("Creatinine_min histogram")

# ----------------------------------------Troponin_diff----------------------------#
summary(icu_patients_df1$TroponinI_diff)
ggplot(icu_patients_df1, aes(TroponinI_diff)) + geom_histogram(fill = "red") +
          ggtitle("TroponinI_diff histogram")

# ----------------------------------------Troponin_max----------------------------#
summary(icu_patients_df1$TroponinI_max)
ggplot(icu_patients_df1, aes(TroponinI_max)) + geom_histogram(fill = "red") +
          ggtitle("TroponinI_max histogram")

# ----------------------------------------Troponin_min----------------------------#
summary(icu_patients_df1$TroponinI_min)
ggplot(icu_patients_df1, aes(TroponinI_min)) + geom_histogram(fill = "red") +
          ggtitle("TroponinI_min histogram")
```






## Save, knit and submit

**Reminder**: don't forget to save this file, to knit it to check that everything works, and then submit via the drop box in OpenLearning.

## Submit your assignment

When you have finished, and are satisfied with your assignment solutions, and this file knits without errors and the output looks the way you want, then you should submit via the drop box in OpenLearning.

### Problems?

If you encounter problems with any part of the process described above, please contact the course convenor via OpenLearning as soon as possible so that the issues can be resolved in good time, and well before the assignment is due.


### Additional Information

Each task attracts the indicated number of marks (out of a total of 30 marks for the assignment). The instructions are deliberately open-ended and less prescriptive than the individual assignments to allow you some latitude in what you do and how you go about the task. However, to complete the tasks and gain full marks, you only need to replicate or repeat the steps covered in the course - if you do most or all of the things described in the revalant chapters of the HDAT9600 course, full marks will be awarded. 

Note also that with respect to the model fitting, there are no **right** or **wrong** answers when it comes to variable selection and other aspects of model specification. Deep understanding of the underlying medical concepts which govern patient treatment and outcomes in ICUs is not required or assumed, although you should try to gain some understanding of each variable using the links provided. You will not be marked down if your medical justifications are not exactly correct or complete, but do you best, and don't hesitate to seek help from the course convenor.
